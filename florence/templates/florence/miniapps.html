{% extends "florence/layout.html" %}

{% block css %}
  {{ block.super }}
  <style>
    .fade-enter-active, .fade-leave-active {
      transition: all 0.2s ease;
    }
    .fade-enter, .fade-leave-to {
      /* bottom: -50%; */
      opacity: 0;
      transform: translateY(50%);
    }
  </style>
{% endblock css %}


{% block mastbody %}
<div class="ui center aligned vertical segment" style="background:lightblue;border:none;height:300px;">
  <div class='ui text container'>
    {% verbatim %}
    <div id="importer">
      <importbar
        v-for='(imp, index) in imported'
        :item='imp'
        :key='index'
        @remove='imported.splice(index, 1)'
        @show_info='focused=imp'
      ></importbar>

      <importinfo
        :item='focused'
      ></importinfo>
    </div>
    {% endverbatim %}
  </div>
</div>
{% endblock mastbody %}


{% block js %}
  {{ block.super }}
  {% verbatim %}
  <script type='text/x-template' id='importbar-template'>
    <div style='margin-bottom:5px;' @click='$emit("show_info")'>
      <div class="ui labeled fluid button">
        <div class="ui black fluid button" style='text-align:left;'>
          {{ item.name }}
        </div>
        <a class="ui basic black left pointing label" style='position:relative;padding-right:50px'>
          {{ item.alias }}
          <i class="material-icons" @click='$emit("remove")' style='position:absolute;top:50%;right:5px;transform:translate(0,-50%);'>close</i>
        </a>
      </div>
    </div>
  </script>

  <script type='text/x-template' id='importinfo-template'>
    <transition name='fade'>
      <div v-if='item' style='position:fixed;z-index:50;background:white;left:0;right:0;height:70%;bottom:0;border-radius:20px 20px 0 0;box-shadow:0 -10px 50px rgba(0,0,0,0.2);'>
        {{ item.code }}
      </div>
    </transition>
  </script>



  <script>
    Vue.component('importbar', {
      template: '#importbar-template',
      props: ['item']
    })

    Vue.component('importinfo', {
      template: '#importinfo-template',
      props: ['item']
    })


    var importer = new Vue({
      el: '#importer',

      data: {
        imported: [],
        focused: false,
        spinner: new Spinner(),
      },

      methods: {
        spinner_start: function() {
          this.spinner.spin(document.body);
        },

        spinner_stop: function() {
          this.spinner.stop();
        },

        has: function(alias) {
          for (imp of this.imported) {
            if (imp.alias==alias) {
              console.log('alias duplicated');
              return true;
            }
          }

          return false;
        },

        import_cdn: function(url, alias) {
          if (this.has(alias)) return;

          var importer = this;
          importer.spinner_start();

          fetch(url)
            .then(x => x.text())
            .then(function(code) {
              importer.imported.unshift({
                alias: alias,
                name: url.split('/').slice(-1)[0],
                code: code
              });
              importer.spinner_stop();
            }
          );
        }
      }
    })
  </script>
  {% endverbatim %}
{% endblock js %}
