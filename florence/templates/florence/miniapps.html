{% extends "florence/layout.html" %}

{% block css %}
  {{ block.super }}
  <style>
  </style>
{% endblock css %}


{% block mastbody %}
<div class="ui center aligned vertical segment" style="background:none;border:none;">
  <div id='module'>
    <importview :imported='imported'></importview>
    <editorview :code='code' @testify='testify'></editorview>

    <div class='ui text container'>
      <div><canvas id='mychart'></canvas></div>
    </div>
  </div>
</div>
{% endblock mastbody %}


{% block js %}
  {{ block.super }}
  {% include "florence/vcomp/importview.html" %}
  {% include "florence/vcomp/libview.html" %}
  {% include "florence/vcomp/editorview.html" %}

  <script>
    var module = new Vue({
      el: '#module',
      delimiters: ['[[', ']]'],
      data: {
        imported: {},
        code: `// TYPE YOUR CODE HERE

class MultiAlphastock extends alphastock.Alphastock {
  opt = {
    symbols: ['goog', 'aapl'],
    apikey: '2JOML1ZPSME2Q28A',
    fields: ['open', 'high', 'low', 'close', 'adj_close', 'volume', 'div_amount', 'split']
  };

  async get(opt) {
    //   axios.get('https://yesno.wtf/api')
    //       .then(function (response) {
    //         vm.answer = _.capitalize(response.data.answer)
    //       })
    // const url = 'https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=MSFT&interval=5min&apikey=demo';
    // return await axios.get(url)
    //                 .then(res => res.json())
    //                 .then(json => json["Time Series (5min)"]);
    return jq.map([1,2,3], (item)=>{return item*2})
  }
}

const mstocks = new MultiAlphastock();
// stocks.opt.symbol = 'goog';
// stocks.opt.apikey = '2JOML1ZPSME2Q28A';
mstocks.test();`
      },

      methods: {
        testify: function(code) {
          testify(code);
        }
      }
    });

    // function import_module(module_id) {
    //   $.ajax({
    //     type: 'GET',
    //     url: '/florence/lib/' + module_id + '/family/',
    //     dataType:'json',
    //     cache: false,
    //     success: function(resp) {
    //       console.log(resp.family);
    //       console.log(modulize(resp.family));
    //     },
    //     error: function(xhr, errmsg, err) {
    //       console.log(xhr.status + ': ' + xhr.responseText);
    //     },
    //     complete: function() {}
    //   });
    // }
    //
    //

    function testify(code) {
      let _imports = math.transpose(Object.entries(module.imported));
      let _modulized = _imports[1].map(function(imp) {
        if ('url' in imp) {
          return imp.url;
        } else {
          return modulize(imp);
        }
      });


      const prepend = `requirejs.config({
        map: {
          '*': {
              'jquery': "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"
          }
        }
      });`

      // paths: {
      //   "lodash": "https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min",
      //   "jquery": "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min"
      // },

      // _modulized.push('lodash');
      // _imports[0].push('lod');
      //
      // _modulized.push('jquery');
      // _imports[0].push('jq');

      modulized = `requirejs(${JSON.stringify(_modulized)}, function(${_imports[0]}) {
        ${code}
      })`;


      let blob = new Blob([modulized], {type: 'text/javascript'});
      let js = URL.createObjectURL(blob);

      console.log(js);
      import(js).then(testjs => {
        // console.log('test');
      });
    }


    function modulize(tree) {
      let modulized;
      let exps;

      if (tree.exports) {
        exps = tree.exports.map(exp => exp + ':' + exp).join(', ');
      }

      if (jQuery.isEmptyObject(tree.imports)) {
        modulized = `define(function(){
          ${tree.code}
          return { ${exps} }
        })`;

      } else {
        let _imports = math.transpose(Object.entries(tree.imports));
        let _modulized = _imports[1].map(function(imp) {
          // if (typeof imp === 'string') {
          if (imp.url) {
            return imp.url;
          } else {
            return modulize(imp);
          }
        });
        modulized = `define(${JSON.stringify(_modulized)}, function(${_imports[0]}) {
          ${tree.code}
          return { ${exps} }
        })`
      }

      let blob = new Blob([modulized], {type: 'text/javascript'});
      return URL.createObjectURL(blob);
    }
  </script>
{% endblock js %}
