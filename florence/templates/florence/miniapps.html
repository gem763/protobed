{% extends "florence/layout.html" %}

{% block css %}
  {{ block.super }}
  <style>
  </style>
{% endblock css %}


{% block mastbody %}
<div class="ui center aligned vertical segment" style="background:none;border:none;">
  <div id='module'>
    <importview :imported='imported'></importview>
    <editorview :code='code' @testify='testify'></editorview>

    <div class='ui text container'>
      <div><canvas id='mychart'></canvas></div>
    </div>
  </div>
</div>
{% endblock mastbody %}


{% block js %}
  {{ block.super }}
  {% include "florence/vcomp/importview.html" %}
  {% include "florence/vcomp/libview.html" %}
  {% include "florence/vcomp/editorview.html" %}

  <script>
    var module = new Vue({
      el: '#module',
      delimiters: ['[[', ']]'],
      data: {
        imported: {},
        code: `// TYPE YOUR CODE HERE

const stocks = new alphastock.AlphaVantageStockDataSourcer();
const params = {
  apikey: '2JOML1ZPSME2Q28A',
  symbol: 'aapl'
};

stocks.get_test(params);`
      },

      methods: {
        testify: function() {
          testify();
        }
      }
    });

    // function import_module(module_id) {
    //   $.ajax({
    //     type: 'GET',
    //     url: '/florence/lib/' + module_id + '/family/',
    //     dataType:'json',
    //     cache: false,
    //     success: function(resp) {
    //       console.log(resp.family);
    //       console.log(modulize(resp.family));
    //     },
    //     error: function(xhr, errmsg, err) {
    //       console.log(xhr.status + ': ' + xhr.responseText);
    //     },
    //     complete: function() {}
    //   });
    // }
    //
    //

    function testify() {
      // let mymodule = modulize(tree); console.log(mymodule);
      // requirejs([mymodule], function(mod) {
      //   const stocks = new mod[tree.exports]();
      //   const params = {
      //     apikey: '2JOML1ZPSME2Q28A',
      //     symbol: 'aapl'
      //   };
      //
      //   stocks.get_test(params);
      // })

      let _imports = math.transpose(Object.entries(module.imported));
      let _modulized = _imports[1].map(function(imp) {
        if (typeof imp === 'string') {
          return imp;
        } else {
          return modulize(imp);
        }
      });

      modulized = `requirejs(${JSON.stringify(_modulized)}, function(${_imports[0]}) {
        ${module.code}
      })`;

      let blob = new Blob([modulized], {type: 'text/javascript'});
      let js = URL.createObjectURL(blob);

      // console.log(js);
      import(js).then(testjs => {
        // console.log('test');
      });
    }


    function modulize(tree) {
      let modulized;
      let exps;

      if (tree.exports) {
        exps = tree.exports.map(exp => exp + ':' + exp).join(', ');
      }

      if (jQuery.isEmptyObject(tree.imports)) {
        modulized = `define(function(){
          ${tree.code}
          return { ${exps} }
        })`;

      } else {
        let _imports = math.transpose(Object.entries(tree.imports));
        let _modulized = _imports[1].map(function(imp) {
          // if (typeof imp === 'string') {
          if (imp.url) {
            return imp.url;
          } else {
            return modulize(imp);
          }
        });
        modulized = `define(${JSON.stringify(_modulized)}, function(${_imports[0]}) {
          ${tree.code}
          return { ${exps} }
        })`
      }

      let blob = new Blob([modulized], {type: 'text/javascript'});
      return URL.createObjectURL(blob);
    }
  </script>
{% endblock js %}
