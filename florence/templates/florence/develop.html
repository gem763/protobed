{% extends "florence/layout.html" %}

{% block css %}
  {{ block.super }}
  <style>
    .codebox {
      width: 100%;
      background: whitesmoke;
      padding: 10px;
      border-radius: 10px;
    }

    #jsmodule {
      min-height: 100px;
      background: none;
    }

    .ace_mobile-menu {
      display: none !important;
    }
  </style>
{% endblock css %}


{% block mastbody %}
<div class="ui center aligned vertical segment" style="background:none;">
  <div class="ui text container">

    Code
    <div id='endpoint'>
    </div>

    <div id='codebox'>
      <!-- <div id="jsmodule">function foo(items) {
  var x = "All this is syntax highlighted";
  return x;
}</div> -->
    </div>

    <br>
    <button id="testify1" class="ui black button">Editor TEST</button>
    <button id="testify2" class="ui black button">DB TEST</button>

    <!-- <div id="my-element"></div> -->
  </div>
</div>
{% endblock mastbody %}

{% block js %}
  {{ block.super }}
  <script src="https://embed.runkit.com"></script>

  <script>
    var notebook = RunKit.createNotebook({
      // the parent element for the new notebook
      element: document.getElementById("codebox"),
      // specify the source of the notebook
      source: "// GeoJSON!\nvar getJSON = require(\"async-get-json\");\n\nawait getJSON(\"https://storage.googleapis.com/maps-devrel/google.json\");"
    });

    var endpoint = RunKit.createNotebook({
      // the parent element for the new notebook
      element: document.getElementById("endpoint"),
      // specify the source of the notebook
      source: "",
      // mode: 'endpoint'
    });

    // let jsmodule = ace.edit("jsmodule");
    //
    // jsmodule.setOptions({
		// 	maxLines: Infinity,        // 줄 전체를 표시
		// 	highlightActiveLine: true, // 현재 행에 하이라이트 표시
		// 	theme: 'ace/theme/chrome', // 표시 테마
    //   showGutter: false,
    //   readOnly: false,
    //   mode: "ace/mode/javascript"
		// })
    //
    // jsmodule.commands.addCommand({
    //   name: "showKeyboardShortcuts",
    //   bindKey: {win: "Ctrl-Alt-h", mac: "Command-Alt-h"},
    //   exec: function(editor) {
    //           ace.config.loadModule("ace/ext/keybinding_menu", function(module) {
    //               module.init(editor);
    //               editor.showKeyboardShortcuts()
    //           });
    //         }
    // })

    $('#testify1').click(function() {
      // const moduleset = { code: jsmodule.getValue() };
      // testify(moduleset);
      notebook.getSource(function(code) {
        const moduleset = { code: code };
        testify(moduleset);
      });
    });


    $('#testify2').click(function() {
      $.ajax({
        url: '{% url "getcode" %}',
        type: 'GET',
        data: {},
        dataType:'json',
        cache: false,
        contentType: false,
        processData: false,
        success: function(json) {
          const moduleset = { code: json.code };
          testify(moduleset);
        }
      });
    });

    // 코드를 모듈로 만들기
    function modulize(moduleset) {
      let export_key = /class (\w+) /.exec(moduleset.code)[1];
      let modulized;

      if (moduleset.imports==undefined) {
        modulized = `define(function(){
          return {
            ${export_key}: ${moduleset.code}
          }
        })`;

        // modulized = `define(function(){
        //   return {
        //     export: ${moduleset.code}
        //   }
        // })`;

      } else {
        let _imports = math.transpose(Object.entries(moduleset.imports));
        let _modulized = _imports[1].map(_moduleset => modulize(_moduleset));

        modulized = `define(${JSON.stringify(_modulized)}, function(${_imports[0]}) {
          return {
            ${export_key}: ${moduleset.code}
          }
        })`
      }

      let blob = new Blob([modulized], {type: 'text/javascript'});
      return URL.createObjectURL(blob);
    }



    // 코드 테스트하기
    function testify(moduleset) {
      let mymodule = modulize(moduleset); console.log(mymodule);
      let export_key = /class (\w+) /.exec(moduleset.code)[1];
      let target;

      requirejs([mymodule], function(mod) {
        target = mod[export_key];

        let params = {
          apikey: '2JOML1ZPSME2Q28A',
          sym: 'aapl',
          interval: 'daily',
          nbar:5
        };

        let mysrc = new target();
        mysrc.get(params).then(function(output) {
          console.log(output);
        });
      })
    }

  </script>
{% endblock js %}
